{% for image in block.image %}
  {% if block.treated %}
    {% set treatedEffects = { modulate: [100, 0, 100], clut: 'gradient:#000000-#ffffff' } %}
  {% else %}
    {% set treatedEffects = {} %}
  {% endif %}
  {% if block.size matches '/halfWidth/' %}
    {% set imgSrcSets = [ { width: 1200 }, { width: 750, jpegQuality: 65 }, ]  %}
    {% set imgSizes = '(max-width: 768px) 100vw, 50vw' %}
  {% else %}
    {% set imgSrcSets = [ { width: 2000 }, { width: 750, jpegQuality: 65 }, ]  %}
    {% set imgSizes = '100vw' %}
  {% endif %}

  {% set embeddedAsset = craft.embeddedAssets.get(image) %}
  <div class="block-image -reveal {{ block.size }}">
    <div class="-inner">
    {% if embeddedAsset %}
      {# Custom vimeo handling #}
      {% if embeddedAsset.url matches '/vimeo\.com/' %}
        <div class="embedded-asset vimeo-block{{ block.backgroundVideo ? ' background-video' : '' }}" data-url="{{ embeddedAsset.url }}" data-width="{{ embeddedAsset.width }}" data-height="{{ embeddedAsset.height }}">
          <img class="lazyload" data-src="{{ embeddedAsset.images[0].url }}">
        </div>
      {% else %}
        {{ embeddedAsset.html }}
      {% endif %}
    {% else %}

      {# Leave (untreated) GIFs alone #}
      {% if image.filename matches '/gif$/' and not block.treated %}
        {% set treatedImage = image %}
      {% else %}
        {% set transformedImages = craft.imager.transformImage(image, imgSrcSets, { format: 'jpg', jpegQuality: 80, interlace: true, effects: treatedEffects }) %}
        {% if craft.imager.serverSupportsWebp() %}
          {% set transformedImagesWebp = craft.imager.transformImage(image, imgSrcSets, { format: 'webp', jpegQuality: 80, interlace: true, effects: treatedEffects }) %}
        {% endif %}
      {% endif %}

      {%- if browserFrame is defined and browserFrame.browserFrameActive %}
        <div class="browser-frame">
          <div class="browserdots"></div>
          <div class="site{% if browserFrame.browserFrameScroll %} scroll{% endif %}"{% if browserFrame.browserFrameScroll %} style="padding-bottom:{{ browserFrame.scrollHeight }}%;"{% endif %}>
            {%- if browserFrame.browserFrameScroll %}<div class="scroll-content">{% endif -%}
      {% endif -%}

      <figure>
        <div class="-aspect-ratio-pad" style="padding-bottom: {{ image.height / image.width * 100 }}%">
          {%- if block.imageLinkUrl %}<a href="{{ block.imageLinkUrl }}" target="_blank" rel="noopener">{% endif -%}

            <picture>
            {% if image.filename matches '/gif$/' and not block.treated %}
              <img class="lazyload" src="{{ craft.imager.base64Pixel(2,1) }}" data-src="{{ treatedImage.getUrl() }}" alt="{{ image.altText | length ? image.altText : image.title }}">
            {% else %}
                {% if transformedImagesWebp is defined %}
                  <source data-sizes="{{ imgSizes }}" data-srcset="{{ craft.imager.srcset(transformedImagesWebp) }}" type="image/webp">
                {% endif %}
                <img class="lazyload" src="{{ craft.imager.base64Pixel(2,1) }}" data-sizes="{{ imgSizes }}" data-srcset="{{ craft.imager.srcset(transformedImages) }}" alt="{{ image.altText | length ? image.altText : image.title }}">
            {% endif -%}
            </picture>

          {%- if block.imageLinkUrl %}</a>{% endif -%}
        </div>
        {% if image.caption %}
          <figcaption>{{ image.caption }}</figcaption>
        {% endif %}
      </figure>

      {%- if browserFrame is defined and browserFrame.browserFrameActive %}
          {%- if browserFrame.browserFrameScroll %}</div>{% endif -%}
          </div><!-- .site -->
        </div><!-- .browser-frame -->
      {% endif -%}
    {% endif %}

    {% if block.text and loop.last %}
      <div class="block-text user-content">
        {{ block.text }}
      </div>
    {% endif %}
    </div><!-- /.-inner -->
  </div>
{% endfor %}
